---
argument_specs:
  main:
    short_description: Bootstrap and provision a new machine with ansible
    description: |
      This role allows for bootstrapping machines that haven't been provisioned by ansible yet,
      so can't have ansible run against them in the usual way due to missing user accounts and
      ssh keys.

      This role initially connects to a machine with temporary bootstrap credentials which can
      either be supplied via variable or interactively, this bootstrap user is used to create
      a special ansible provision user with a unique name and UID to avoid collision with any
      user accounts that your ansible playbook wants to add.

      The original bootstrap user can then be optionally deleted (to free up the UID) and any
      ansible tasks can then be run under the autogenerated provision user to setup proper user
      accounts and ssh keys.

      Once this is done the ansible playbook can be run as normal as your regular account.
    options:
      bootstrap_ansible_playbook_dir:
        description: Path to ansible playbook directory
        type: str
        default: "{{ ansible_config_file | dirname }}"

      bootstrap_host_override_prompt:
        description: |
          If true, prompt user if they want to override the hostname or IP address of the machine
          they are provisioning.
        type: bool
        default: true

      bootstrap_username:
        description: |
          Username for the bootstrap user to use for the initial connection to the machine,
          or empty string to prompt the user to provide this interactively
        type: str
        default: ""

      bootstrap_password:
        description: |
          Password for the bootstrap user to use for the initial connection to the machine,
          or empty string to prompt the user to provide this interactively
        type: str
        default: ""

      bootstrap_become_method:
        description: |
          Method to use to escalate from the bootstrap user to root (e.g. sudo or su),
          or empty string to prompt the user to provide this interactively
        type: str
        default: ""

      bootstrap_root_password:
        description: |
          Password for the root user if the become method is su,
          or empty string to prompt the user to provide this interactively
        type: str
        default: ""

      bootstrap_ssh_password_authentication:
        description: |
          If true, use ssh password authentication for the initial connection to the machine,
          or empty string to prompt the user to provide this interactively
        type: bool
        default: ""

      bootstrap_user_remove:
        description: |
          If true, remove the bootstrap user account after
          the provision user account has been created,
          or empty string to prompt the user to provide this interactively
        type: bool
        default: ""

      bootstrap_apt_upgrade:
        description: |
          If true, run full apt upgrade on initial connection to the machine
        type: bool
        default: true

      bootstrap_packages:
        description: |
          List of packages to install on initial connection to the machine
        type: list
        elements: str
        default:
          - sudo

      provision_username:
        description: |
          Username for the provision user account to be created
        type: str
        default: "ansible-provision"

      provision_uid:
        description: |
          UID for the provision user account to be created
        type: int
        default: 50000

      provision_groups:
        description: |
          List of groups the provision user account should be part of
        type: list
        elements: str
        default:
          - sudo

      provision_shell:
        description: |
          Shell for the provision user account to be created
        type: str
        default: /bin/bash

      provision_ssh_key_type:
        description: |
          Type of ssh key that should be created for the provision user account
        type: str
        default: ed25519

      provision_ssh_key_has_passphrase:
        description: |
          If true, create a random passphrease for the provision user's ssh key
          and automatically add this ssh key to the ssh-agent of the user running the
          ansible playbook
        type: bool
        default: true
